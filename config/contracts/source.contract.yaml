version: "3.0.0"
stage: "source"
source: "zephyr"
purpose: "SPECTRA-grade source stage with SDK-driven architecture, comprehensive testing, and dashboard-ready portfolio."
owner: "Data Platform"

inputs:
  auth_method: "apiToken"
  variable_library: "zephyrVariables"
  variables:
    # Clean, non-prefixed variable names in Variable Library
    - "base_url"          # Zephyr API base URL
    - "api_token"         # Zephyr API authentication token
    - "base_path"         # Zephyr API base path
    - "source_system"     # Source system identifier (zephyr)
    - "contract_version"  # Contract version (3.0.0)
  
  sdk:
    name: "spectraSDK"
    version: "0.3.0"
    maturity: "L1 - MVP"
    location: "spectraSDK.Notebook"
    
  exclusions:
    - "No secrets in contract; reference variable names only."
    - "Secrets stored in Fabric Variable Library and loaded at runtime."

obligations:
  core:
    - "Auth succeeds against Zephyr base URL + path for all accessible endpoints."
    - "Hierarchical access validated: Projects → Releases → Cycles → Executions → Test Cases."
    - "Endpoint catalog comprehensive (228 endpoints embedded in SDK)."
    - "Dynamic project discovery via API (no hardcoded project IDs)."
    - "Visibility demonstrated across all hierarchy levels with preview samples."
    - "Known limitations documented with root cause analysis."
    
  data_outputs:
    - "source.portfolio: Metadata table for source system dashboard (auth status, endpoint metrics, capabilities)."
    - "source.config: Runtime configuration snapshot."
    - "source.credentials: Masked credential validation status."
    - "source.endpoints: Complete endpoint catalog (228 endpoints)."
    - "source.sampleProjects: Preview sample of projects."
    - "source.sampleReleases: Preview sample of releases."
    - "source.sampleCycles: Preview sample of cycles."
    - "source.sampleExecutions: Preview sample of test executions."
    - "source.sampleTestcases: Preview sample of test cases."
    
  quality:
    - "Comprehensive test suite with >75% coverage (pytest + GitHub Actions)."
    - "CI/CD pipeline validates all changes automatically."
    - "Data validation functions for API responses, schemas, row counts, nulls, duplicates."
    - "Error handling with retry logic, graceful degradation, structured reporting."
    - "Comprehensive manifest entry recorded with quality gates."

dependencies:
  workspace_id: "16490dde-33b4-446e-8120-c12b0a68ed88"
  pipeline_id: "be9d0663-d383-4fe6-a0aa-8ed4781e9e87"
  notebook_id: "a744c881-065a-8e92-4cbb-2f6620f5ce36"
  lakehouse_id: "5cb93b81-8923-a984-4c5b-a9ec9325ae26"
  environment_id: "92a8349b-6a62-b2e9-40bf-1ac52e9ab184"
  
  sdk_dependencies:
    - "spectraSDK.Notebook (0.3.0)"
    - "NotebookSession (7-stage lifecycle orchestration)"
    - "SourceStageHelpers (static methods for common operations)"
    - "DataValidation (API response, schema, row count, null, duplicate checks)"
    - "DeltaTable (write, register, merge, optimize, vacuum)"
    - "SPECTRALogger (context-aware logging with smart debug mode)"
    - "VariableLibrary (type-safe Variable Library access)"
    - "Pipeline (interactive vs pipeline mode detection)"
    - "Environment (Fabric runtime context)"

outputs:
  manifest_path: "manifests/source.manifest.yaml"
  journal_path: "Core/memory/journal/2025-12-05-zephyr-source-spectra-grade.md"
  test_suite: "tests/"
  ci_cd_workflow: ".github/workflows/test.yml"
  
  delta_tables:
    # Portfolio and configuration
    - "Tables/source/portfolio"        # Source system metadata for dashboard
    - "Tables/source/config"           # Runtime configuration snapshot
    - "Tables/source/credentials"      # Masked credential validation
    
    # Endpoint catalog
    - "Tables/source/endpoints"        # 228 endpoints (embedded in SDK)
    
    # Preview samples (for Prepare stage schema design)
    - "Tables/source/sampleProjects"     # Preview: Projects
    - "Tables/source/sampleReleases"     # Preview: Releases
    - "Tables/source/sampleCycles"       # Preview: Cycles
    - "Tables/source/sampleExecutions"   # Preview: Test Executions
    - "Tables/source/sampleTestcases"    # Preview: Test Cases
  
  test_coverage:
    - "Unit tests: test_source_stage_helpers.py (>80% coverage)"
    - "Validation tests: test_validation.py (>90% coverage)"
    - "Error handling tests: test_error_handling.py (>80% coverage)"
    - "Integration tests: test_integration.py (end-to-end flows)"
    - "Overall target: >75% coverage"
  
  purpose: "Source stage provides SPECTRA-grade infrastructure with comprehensive testing, dashboard-ready portfolio, and preview samples for Prepare stage."

validation:
  completed_date: "2025-12-05"
  validation_approach: "spectra_grade"
  
  api_authentication:
    status: "validated"
    method: "Bearer Token"
    auth_failures: 0
    dynamic_project_discovery: true
    
  hierarchical_access:
    validated: true
    architecture: "hierarchical"
    levels: 5
    flow: "Projects → Releases → Cycles → Executions → Test Cases"
    extraction_errors: 0
    
  endpoint_catalog:
    total_endpoints: 228
    embedded_in_sdk: true
    categories: ["projects", "releases", "cycles", "executions", "testcases", "testers", "folders"]
    hierarchical_endpoints: 84
    flat_endpoints: 144
    
  preview_samples:
    tables: 5
    sample_limit: 2
    resources:
      - "projects"
      - "releases"
      - "cycles"
      - "executions"
      - "testcases"
    
  test_suite:
    framework: "pytest"
    fixtures: "conftest.py (mock Spark, DeltaTable, Logger, NotebookSession)"
    coverage_target: ">75%"
    test_files:
      - "test_source_stage_helpers.py"
      - "test_validation.py"
      - "test_error_handling.py"
      - "test_integration.py"
    ci_cd: "GitHub Actions (.github/workflows/test.yml)"
    
  data_validation:
    api_response_validation: true
    schema_validation: true
    row_count_validation: true
    null_value_checks: true
    uniqueness_checks: true
    composite_quality_checks: true

quality_gates:
  authentication:
    - "✅ Auth succeeds against Zephyr API with Bearer Token"
    - "✅ No auth failures across all tested endpoints"
    - "✅ Credentials masked in source.credentials table (***_{last_3_chars})"
    
  hierarchical_access:
    - "✅ Hierarchical access validated across 5 levels"
    - "✅ Dynamic project discovery via API (no hardcoded IDs)"
    - "✅ Zero extraction errors in preview samples"
    
  endpoint_catalog:
    - "✅ 228 endpoints catalogued and embedded in SDK"
    - "✅ Endpoint categories mapped to resource types"
    - "✅ Hierarchical endpoints identified and flagged"
    
  data_quality:
    - "✅ Preview samples extracted for all 5 resource types"
    - "✅ Data validation functions implemented (API, schema, row count, nulls, duplicates)"
    - "✅ Error handling with retry, graceful degradation, structured reporting"
    
  testing:
    - "✅ Comprehensive test suite with >75% coverage target"
    - "✅ CI/CD pipeline with GitHub Actions"
    - "✅ Automated coverage reporting to Codecov"
    
  documentation:
    - "✅ Contract and manifest updated to v3.0.0"
    - "✅ Test suite documentation (tests/README.md)"
    - "✅ Coverage badges in README.md"
    
  overall:
    status: "SPECTRA-grade"
    maturity: "L1 - MVP"
    ready_for_next_stage: true
versioning:
  change_log:
    - version: "3.0.0"
      date: "2025-12-05"
      maturity: "L1 - MVP"
      changes:
        - "SPECTRA-grade transformation with spectraSDK (v0.3.0)"
        - "7-stage notebook lifecycle (NotebookSession orchestration)"
        - "Renamed fabricSDK → spectraSDK for consistency"
        - "Variable Library with clean names (base_url, api_token, base_path)"
        - "New table structure: source.portfolio (dashboard-ready), source.config, source.credentials"
        - "228 endpoints embedded in SDK (no JSON file dependency)"
        - "Dynamic project discovery (no hardcoded IDs)"
        - "Preview samples for 5 resource types (projects, releases, cycles, executions, testcases)"
        - "Comprehensive test suite (pytest): >75% coverage target"
        - "Unit tests (test_source_stage_helpers.py): >80% coverage"
        - "Validation tests (test_validation.py): >90% coverage"
        - "Error handling tests (test_error_handling.py): >80% coverage"
        - "Integration tests (test_integration.py): end-to-end flows"
        - "CI/CD pipeline with GitHub Actions (.github/workflows/test.yml)"
        - "Automated coverage reporting to Codecov"
        - "DataValidation class: API response, schema, row count, null, duplicate checks"
        - "SourceStageHelpers class: static methods for common operations"
        - "Error handling: retry logic, graceful degradation, structured reporting"
        - "API token masking in credentials table (***_{last_3_chars})"
        - "Updated lakehouse ID to 5cb93b81-8923-a984-4c5b-a9ec9325ae26"
        - "Schema support enabled (direct schema.table notation)"
      breaking_changes:
        - "Removed DXC_ZEPHYR_* prefixed variables → clean Variable Library names"
        - "Removed source.source → source.portfolio (redesigned as dashboard metadata)"
        - "Removed legacy tables (hierarchical_validation, endpoint_health, quality_gate_report)"
        - "Removed JSON file dependency → endpoints embedded in SDK"
        - "Notebook now requires %run spectraSDK at top"
        - "Variable Library must be populated with: base_url, api_token, base_path, source_system, contract_version"
      sdk_features:
        - "NotebookSession: 7-stage lifecycle (Parameters, Context, Initialize, Execute, Validate, Record, Finalise)"
        - "SourceStageHelpers: create_source_portfolio_table, create_source_config_table, create_source_credentials_table, validate_api_authentication, validate_api_resource_access, bootstrap_endpoints_catalog, extract_preview_sample"
        - "DataValidation: validate_api_response, validate_dataframe_schema, validate_row_count, check_for_nulls, check_for_duplicates, composite_data_quality_check"
        - "DeltaTable: write, register, merge, optimize, vacuum (with schema evolution)"
        - "SPECTRALogger: context-aware logging with smart debug mode"
        - "VariableLibrary: type-safe Variable Library access"
        - "Pipeline: interactive vs pipeline mode detection"
        - "Environment: Fabric runtime context (workspace, lakehouse, tenant IDs)"
      
    - version: "2.0.0"
      date: "2025-12-02"
      changes:
        - "Comprehensive endpoint testing (120 endpoints)"
        - "Discovered hierarchical API architecture"
        - "Validated all 4 hierarchy levels with actual data"
        - "Extracted sample dimensional dataset (265 rows)"
        - "Found 29 ID types including defectId and requirementId"
        - "Tested with actual IDs to prove service issues"
        - "Documented 3 confirmed limitations with workarounds"
        - "Achieved 70% endpoint success rate (84/120)"
        - "Generated 27 comprehensive deliverables"
        - "Quality score: 95/100 (Excellent)"
      breaking_changes:
        - "Updated from simple /project handshake to comprehensive validation"
        - "Added hierarchical access requirements"
        - "Changed success criteria from single endpoint to full hierarchy"
        
    - version: "1.0.0"
      date: "2025-01-29"
      changes:
        - "Initial Source contract"
        - "Basic /project endpoint handshake"
