# Zephyr Prepare Stage Documentation

This directory contains documentation and configuration for the Zephyr Prepare stage.

---

## Overview

The Prepare stage creates **metadata-driven configuration tables** that drive downstream Extract, Clean, Transform, and Refine stages. These tables are schema-only (no data rows) and define:

- **Field-level metadata** for all Zephyr entities
- **API endpoint configurations** for data extraction
- **Status mappings** for execution statuses

---

## Key Documents

### Design Documents

- **`PREPARE-STAGE-SCHEMA-DESIGN.md`** - Complete schema design specification
  - Schema table structure
  - Entity hierarchy & grouping
  - Structure type patterns (scalar, record, array)
  - Schema generation workflow
  - Validation rules

### Generated Artifacts

- **`prepare_schema_generated.json`** - Auto-generated Prepare stage schema
  - Generated by: `scripts/generate_prepare_schema.py`
  - Source: Discovered entity schemas from `docs/schemas/discovered/`
  - Format: Prepare stage schema table structure

---

## Schema Generation Workflow

### 1. Discover Entity Schemas

**Tool:** `scripts/discover_schemas_via_creation.py`

Creates sample entities in SpectraTestProject and captures full API response schemas.

```bash
python scripts/discover_schemas_via_creation.py
```

**Output:** `docs/schemas/discovered/*_created_response.json`

---

### 2. Generate Prepare Schema

**Tool:** `scripts/generate_prepare_schema.py`

Analyzes discovered schemas and generates Prepare stage schema definitions.

```bash
python scripts/generate_prepare_schema.py
```

**Output:** `docs/prepare/prepare_schema_generated.json`

**Process:**
- Reads discovered schema JSON files
- Analyzes structure (scalar/record/array)
- Infers data types
- Generates Prepare stage schema format
- Handles nested objects and arrays

---

### 3. Review & Refine

**Manual Steps:**
1. Review generated schema in `prepare_schema_generated.json`
2. Set `isNullable` based on API documentation
3. Add descriptive `description` fields
4. Set `dimensionName` for dimension tables (see `docs/refine/DIMENSIONAL-MODEL-DESIGN.md`)
5. Set `bridgeName` for array bridges
6. Validate against SpectraTestProject

---

### 4. Integrate into Notebook

**Notebook:** `2-prepare/prepareZephyr.Notebook/notebook_content.py`

- Loads schema from generated JSON (or embedded fallback)
- Creates `prepare._schema`, `prepare._endpoints`, `prepare._statusMap` Delta tables
- Validates schema coherence
- Registers tables in Spark metastore

---

## Schema Table Structure

See **`PREPARE-STAGE-SCHEMA-DESIGN.md`** for complete specification.

**Key Fields:**
- `group`, `entity` - Logical grouping
- `fieldId` - Field identifier
- `structureType` - **scalar** | **record** | **array**
- `rawField`, `targetField` - JSON path mapping
- `dataType` - SLT types (text, int64, float64, bool, date, datetime, json)
- `isNullable` - Nullability
- `dimensionName` - Target dimension table
- `bridgeName` - Bridge table for arrays

---

## Output Tables

### `prepare._schema`

Field-level metadata for all Zephyr entities (projects, releases, cycles, testcases, executions, requirements, folders).

**Usage:** Drives Extract stage field extraction and Clean stage validation.

---

### `prepare._endpoints`

API endpoint configurations for data extraction.

**Usage:** Configures Extract stage API calls.

---

### `prepare._statusMap`

Status mappings for execution statuses (Passed, Failed, Blocked, Not Executed).

**Usage:** Standardizes status values across the pipeline.

---

## Validation

The Prepare stage validates:

1. **Schema Coherence:**
   - Array entities must have `bridgeName` set
   - Dimension name consistency (one `dimensionName` per entity)

2. **Row Counts:**
   - Schema fields > 0
   - Expected endpoint count
   - Expected status map count

---

## Next Steps

After Prepare stage completes:

1. **Extract Stage** - Uses `prepare._schema` and `prepare._endpoints` to extract data
2. **Clean Stage** - Uses `prepare._schema` for validation rules
3. **Transform Stage** - Uses `prepare._schema` for field mappings
4. **Refine Stage** - Uses `prepare._schema` (`dimensionName`, `bridgeName`) to build dimensional model

---

## References

- **Prepare Schema Design:** `PREPARE-STAGE-SCHEMA-DESIGN.md`
- **Dimensional Model Design:** `../refine/DIMENSIONAL-MODEL-DESIGN.md`
- **Zephyr Research:** `../ZEPHYR-RESEARCH-SUMMARY.md`
- **Source Stage:** `../source/README.md`
- **Jira Pattern:** `Data/jira/2-prepare/prepareJiraConfig.Notebook/notebook_content.py`

